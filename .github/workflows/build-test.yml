name: Build and Test

on:
  push:
    branches: [ main, develop, claude/** ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  build-and-test:
    name: Build and Test - ${{ matrix.board }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        board: [native_sim, qemu_cortex_m3]

    steps:
      - name: Free up disk space
        run: |
          echo "=== Disk space before cleanup ==="
          df -h

          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo rm -rf /usr/local/share/boost
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"
          sudo apt-get clean

          echo "=== Disk space after cleanup ==="
          df -h

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Initialize Zephyr workspace and build all
        run: |
          docker run --rm \
            -v ${{ github.workspace }}:/workspace \
            -w /workspace \
            ghcr.io/zephyrproject-rtos/ci:v0.26.13 \
            bash -c '
              set -e
              echo "=== Initializing Zephyr workspace ==="
              west init -l .
              west update --narrow -o=--depth=1
              west zephyr-export

              echo "=== Building samples ==="
              west build -b ${{ matrix.board }} samples/basic_sine -p
              cp -r build build-basic_sine

              west build -b ${{ matrix.board }} samples/metering_console -p
              cp -r build build-metering_console

              echo "=== Building and running tests ==="
              west build -b ${{ matrix.board }} tests/analyzer_logic -p
              cp -r build build-analyzer_logic

              west build -b ${{ matrix.board }} tests/cow_integrity -p
              cp -r build build-cow_integrity

              west build -b ${{ matrix.board }} tests/memory_check -p
              cp -r build build-memory_check

              west build -b ${{ matrix.board }} tests/spectrum_analyzer_v2 -p
              cp -r build build-spectrum_analyzer_v2
            '

      - name: Run tests on native_sim
        if: matrix.board == 'native_sim'
        run: |
          docker run --rm \
            -v ${{ github.workspace }}:/workspace \
            -w /workspace \
            ghcr.io/zephyrproject-rtos/ci:v0.26.13 \
            bash -c '
              echo "=== Running analyzer_logic test ==="
              timeout 120 ./build-analyzer_logic/zephyr/zephyr.exe || echo "Test completed"

              echo "=== Running cow_integrity test ==="
              timeout 120 ./build-cow_integrity/zephyr/zephyr.exe || echo "Test completed"

              echo "=== Running memory_check test ==="
              timeout 120 ./build-memory_check/zephyr/zephyr.exe || echo "Test completed"

              echo "=== Running spectrum_analyzer_v2 test ==="
              timeout 120 ./build-spectrum_analyzer_v2/zephyr/zephyr.exe || echo "Test completed"
            '

      - name: Upload build artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: builds-${{ matrix.board }}
          path: |
            build-*/zephyr/zephyr.*
          retention-days: 5

  summary:
    name: Build Summary
    runs-on: ubuntu-latest
    needs: [build-and-test]
    if: always()
    steps:
      - name: Check build results
        run: |
          echo "Build and Test Results: ${{ needs.build-and-test.result }}"

          if [ "${{ needs.build-and-test.result }}" != "success" ]; then
            echo "❌ Some builds failed"
            exit 1
          fi
          echo "✅ All builds passed!"
